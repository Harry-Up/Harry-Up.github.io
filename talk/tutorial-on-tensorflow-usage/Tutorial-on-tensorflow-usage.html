<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>Tutorial on tensorflow usage</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="qxbm" id="tutorial-on-tensorflow-usage">Tutorial on tensorflow usage</h1><hr><div class="md-section-divider"></div><h2 data-anchor-id="1zcq" id="outline">Outline</h2><ul data-anchor-id="ah7b">
<li>Brief introduction to tensorflow</li>
<li>Start from a simple CNN</li>
<li>Utilities</li>
<li>Advanced API</li>
<li>Dynamic mode</li>
<li>Appendixes</li>
</ul><hr><div class="md-section-divider"></div><h2 data-anchor-id="d9hx" id="1-brief-introduction-to-tensorflow">1. Brief introduction to tensorflow</h2><div class="md-section-divider"></div><h3 data-anchor-id="3in6" id="11-architectures-of-cpu-and-gpu">1.1. Architectures of CPU and GPU</h3><p></p><center data-anchor-id="0959"><img src="http://static.zybuluo.com/HarryUp/h3e8dcnqczs2klcxbtfqw1ni/%E6%9E%B6%E6%9E%84_meitu_1.jpg" alt="架构_meitu_1.jpg-85.4kB"></center><p></p><ul data-anchor-id="afnl">
<li><strong>CPU:</strong> master in cache and flow control</li>
<li><strong>GPU:</strong> master in numerical calculation</li>
</ul><hr><div class="md-section-divider"></div><h3 data-anchor-id="z9ca" id="12-tensorflow-architecture">1.2. Tensorflow architecture</h3><div class="md-section-divider"></div><h4 data-anchor-id="lcfj" id="121-the-programming-stack">1.2.1. The programming stack</h4><ul data-anchor-id="eg7o">
<li>An open-source software library</li>
<li>Run on multiple (distri) CPUs and GPUs (TPUs)</li>
<li>Support Python, C++, JAVA, Go</li>
</ul><p></p><center data-anchor-id="5scv"><img src="http://static.zybuluo.com/HarryUp/lp0km3wx01mzc44js8qlj1hn/tensorflow_programming_environment_meitu_2.jpg" alt="tensorflow_programming_environment_meitu_2.jpg-99.9kB" title=""></center><p></p><hr><div class="md-section-divider"></div><h4 data-anchor-id="itsm" id="122-units">1.2.2. Units</h4><ul data-anchor-id="tvoz">
<li>Perform computing tasks as a <strong>graph</strong></li>
<li>Execute the graph in the context of <strong>session</strong></li>
<li>Represent data as <strong>tensor</strong></li>
<li>Maintaining states through <strong>variable</strong></li>
<li>Use <strong>feed</strong> and <strong>fetch</strong> to assign values to arbitrary operation or obtain values from it</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ivhv"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> tensorflow </span><span class="kwd">as</span><span class="pln"> tf</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># Creat a variable and initialize it as scalar 0</span></code></li><li class="L3"><code class="language-python"><span class="pln">state </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">"counter"</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># To creat an op, aiming to increase state by 1</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">one </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">int32</span><span class="pun">,</span><span class="pln"> shape</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'one'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">new_value </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> one</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">update </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">assign</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> new_value</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># After the graph startup, variables must be initialized</span></code></li><li class="L2"><code class="language-python"><span class="com"># First, add an `initializer` op into the graph</span></code></li><li class="L3"><code class="language-python"><span class="pln">init_op </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">global_variables_initializer</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># Start the graph, run ops</span></code></li><li class="L6"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Session</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> sess</span><span class="pun">:</span></code></li><li class="L7"><code class="language-python"><span class="pln">  </span><span class="com"># Run 'init' op</span></code></li><li class="L8"><code class="language-python"><span class="pln">  sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">init_op</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">  </span><span class="com"># Print the initial value of 'state'</span></code></li><li class="L0"><code class="language-python"><span class="pln">  </span><span class="kwd">print</span><span class="pun">(</span><span class="pln">sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">state</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"><span class="pln">  </span><span class="com"># Run op to update 'state' and print 'state'</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> _ </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">3</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">update</span><span class="pun">,</span><span class="pln"> feed_dict</span><span class="pun">={</span><span class="pln">one</span><span class="pun">:</span><span class="lit">1</span><span class="pun">})</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="pln">sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">state</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># Output:</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com"># 0</span></code></li><li class="L9"><code class="language-python"><span class="com"># 1</span></code></li><li class="L0"><code class="language-python"><span class="com"># 2</span></code></li><li class="L1"><code class="language-python"><span class="com"># 3</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="cbyx" id="123-gpu-usage">1.2.3. GPU usage</h4><ul data-anchor-id="m81h">
<li>Visual studio (2015)</li>
<li>python 2.7 or 3.5+</li>
<li><strong>CUDA</strong> and <strong>cuDNN</strong></li>
<li>pip or whl <strong>tensorflow-gpu</strong></li>
</ul><hr><div class="md-section-divider"></div><h2 data-anchor-id="lln2" id="2-start-from-a-simple-cnn">2. Start from a simple CNN</h2><div class="md-section-divider"></div><h3 data-anchor-id="b0og" id="21-convolutional-neural-network-model">2.1. Convolutional neural network model</h3><p data-anchor-id="3u3y"><img src="http://static.zybuluo.com/HarryUp/7rd66zcje46marls8qgaaoiq/CNN.png" alt="CNN.png-77.8kB" title=""></p><hr><div class="md-section-divider"></div><h4 data-anchor-id="8nbx" id="211-convolution">2.1.1. Convolution</h4><ul data-anchor-id="kle6">
<li>convolutional kernel</li>
<li>stride</li>
<li>padding <br>
<center><img src="http://static.zybuluo.com/HarryUp/gczvebjg1btpp363b1kv8e0x/%E5%8D%B7%E7%A7%AF%E6%A0%B8.gif" alt="卷积核.gif-5.2kB" title=""></center></li>
</ul><hr><div class="md-section-divider"></div><h4 data-anchor-id="3jpk" id="212-pooling">2.1.2. Pooling</h4><ul data-anchor-id="whdw">
<li>max pooling</li>
<li>mean pooling</li>
</ul><p></p><center data-anchor-id="xjre"><img src="http://static.zybuluo.com/HarryUp/z0seh2xl8wgxxs01ltsichqu/screen-shot-2016-08-10-at-3-38-39-am_meitu_3.jpg" alt="screen-shot-2016-08-10-at-3-38-39-am_meitu_3.jpg-39.2kB" title=""></center><p></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="cgoh" id="22-mnist-database">2.2. MNIST database</h3><ul data-anchor-id="vdw5">
<li>60,000 examples for training and 10,000 examples for testing</li>
<li>size-normalized and centered in a fixed-size image (28x28 pixels)</li>
<li>flattened and converted to a 1-D numpy array of 784 features</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="oxa1"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">tensorflow</span><span class="pun">.</span><span class="pln">examples</span><span class="pun">.</span><span class="pln">tutorials</span><span class="pun">.</span><span class="pln">mnist</span></code></li></ol></pre><p></p><center data-anchor-id="z7zo"><img src="http://static.zybuluo.com/HarryUp/6y1hhojv02affhmayzevuf6d/MNIST.png" alt="MNIST.png-29.7kB" title=""></center><p></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="ghq5" id="23-code-implementation">2.3. Code implementation</h3><div class="md-section-divider"></div><h4 data-anchor-id="s7qz" id="231-preliminary">2.3.1. Preliminary</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wnoa"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> __future__ </span><span class="kwd">import</span><span class="pln"> division</span><span class="pun">,</span><span class="pln"> print_function</span><span class="pun">,</span><span class="pln"> absolute_import</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">import</span><span class="pln"> tensorflow </span><span class="kwd">as</span><span class="pln"> tf</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Import MNIST data</span></code></li><li class="L5"><code class="language-python"><span class="kwd">from</span><span class="pln"> tensorflow</span><span class="pun">.</span><span class="pln">examples</span><span class="pun">.</span><span class="pln">tutorials</span><span class="pun">.</span><span class="pln">mnist </span><span class="kwd">import</span><span class="pln"> input_data</span></code></li><li class="L6"><code class="language-python"><span class="pln">mnist </span><span class="pun">=</span><span class="pln"> input_data</span><span class="pun">.</span><span class="pln">read_data_sets</span><span class="pun">(</span><span class="str">"/tmp/data/"</span><span class="pun">,</span><span class="pln"> one_hot</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com"># Training Parameters</span></code></li><li class="L9"><code class="language-python"><span class="pln">learning_rate </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0.001</span></code></li><li class="L0"><code class="language-python"><span class="pln">num_steps </span><span class="pun">=</span><span class="pln"> </span><span class="lit">500</span></code></li><li class="L1"><code class="language-python"><span class="pln">batch_size </span><span class="pun">=</span><span class="pln"> </span><span class="lit">128</span></code></li><li class="L2"><code class="language-python"><span class="pln">display_step </span><span class="pun">=</span><span class="pln"> </span><span class="lit">10</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Network Parameters</span></code></li><li class="L5"><code class="language-python"><span class="pln">num_input </span><span class="pun">=</span><span class="pln"> </span><span class="lit">784</span><span class="pln"> </span><span class="com"># MNIST data input (img shape: 28*28)</span></code></li><li class="L6"><code class="language-python"><span class="pln">num_classes </span><span class="pun">=</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> </span><span class="com"># MNIST total classes (0-9 digits)</span></code></li><li class="L7"><code class="language-python"><span class="pln">dropout </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0.75</span><span class="pln"> </span><span class="com"># Dropout, probability to keep units</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># tf Graph input</span></code></li><li class="L0"><code class="language-python"><span class="pln">X </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> num_input</span><span class="pun">])</span></code></li><li class="L1"><code class="language-python"><span class="pln">Y </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> num_classes</span><span class="pun">])</span></code></li><li class="L2"><code class="language-python"><span class="pln">keep_prob </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">)</span><span class="pln"> </span><span class="com"># dropout (keep probability)</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="88iq" id="232-creat-model-architecture">2.3.2. Creat model architecture</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="v2w1"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Create some wrappers for simplicity</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> conv2d</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> W</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">,</span><span class="pln"> strides</span><span class="pun">=</span><span class="lit">1</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># Conv2D wrapper, with bias and relu activation</span></code></li><li class="L3"><code class="language-python"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> W</span><span class="pun">,</span><span class="pln"> strides</span><span class="pun">=[</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> strides</span><span class="pun">,</span><span class="pln"> strides</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">],</span><span class="pln"> padding</span><span class="pun">=</span><span class="str">'SAME'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">bias_add</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">relu</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="kwd">def</span><span class="pln"> maxpool2d</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">=</span><span class="lit">2</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="com"># MaxPool2D wrapper</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">max_pool</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> ksize</span><span class="pun">=[</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">],</span><span class="pln"> strides</span><span class="pun">=[</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">],</span></code></li><li class="L1"><code class="language-python"><span class="pln">                          padding</span><span class="pun">=</span><span class="str">'SAME'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Create model</span></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> conv_net</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">,</span><span class="pln"> biases</span><span class="pun">,</span><span class="pln"> dropout</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># MNIST data input is a 1-D vector of 784 features (28*28 pixels)</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="com"># Reshape to match picture format [Height x Width x Channel]</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># Tensor input become 4-D: [Batch Size, Height, Width, Channel]</span></code></li><li class="L9"><code class="language-python"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reshape</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> shape</span><span class="pun">=[-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">28</span><span class="pun">,</span><span class="pln"> </span><span class="lit">28</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="com"># Convolution Layer</span></code></li><li class="L2"><code class="language-python"><span class="pln">    conv1 </span><span class="pun">=</span><span class="pln"> conv2d</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">[</span><span class="str">'wc1'</span><span class="pun">],</span><span class="pln"> biases</span><span class="pun">[</span><span class="str">'bc1'</span><span class="pun">])</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># Max Pooling (down-sampling)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    conv1 </span><span class="pun">=</span><span class="pln"> maxpool2d</span><span class="pun">(</span><span class="pln">conv1</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">=</span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Convolution Layer</span></code></li><li class="L7"><code class="language-python"><span class="pln">    conv2 </span><span class="pun">=</span><span class="pln"> conv2d</span><span class="pun">(</span><span class="pln">conv1</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">[</span><span class="str">'wc2'</span><span class="pun">],</span><span class="pln"> biases</span><span class="pun">[</span><span class="str">'bc2'</span><span class="pun">])</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># Max Pooling (down-sampling)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    conv2 </span><span class="pun">=</span><span class="pln"> maxpool2d</span><span class="pun">(</span><span class="pln">conv2</span><span class="pun">,</span><span class="pln"> k</span><span class="pun">=</span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="com"># Fully connected layer</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># Reshape conv2 output to fit fully connected layer input</span></code></li><li class="L3"><code class="language-python"><span class="pln">    fc1 </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reshape</span><span class="pun">(</span><span class="pln">conv2</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">[</span><span class="str">'wd1'</span><span class="pun">].</span><span class="pln">get_shape</span><span class="pun">().</span><span class="pln">as_list</span><span class="pun">()[</span><span class="lit">0</span><span class="pun">]])</span></code></li><li class="L4"><code class="language-python"><span class="pln">    fc1 </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">matmul</span><span class="pun">(</span><span class="pln">fc1</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">[</span><span class="str">'wd1'</span><span class="pun">]),</span><span class="pln"> biases</span><span class="pun">[</span><span class="str">'bd1'</span><span class="pun">])</span></code></li><li class="L5"><code class="language-python"><span class="pln">    fc1 </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">relu</span><span class="pun">(</span><span class="pln">fc1</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Apply Dropout</span></code></li><li class="L7"><code class="language-python"><span class="pln">    fc1 </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">dropout</span><span class="pun">(</span><span class="pln">fc1</span><span class="pun">,</span><span class="pln"> dropout</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="com"># Output, class prediction</span></code></li><li class="L0"><code class="language-python"><span class="pln">    out </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">matmul</span><span class="pun">(</span><span class="pln">fc1</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">[</span><span class="str">'out'</span><span class="pun">]),</span><span class="pln"> biases</span><span class="pun">[</span><span class="str">'out'</span><span class="pun">])</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> out</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="a0np" id="233-construct-model-graph">2.3.3. Construct model graph</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="97o6"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Store layers weight &amp; bias</span></code></li><li class="L1"><code class="language-python"><span class="pln">weights </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># 5x5 conv, 1 input, 32 outputs</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">'wc1'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">32</span><span class="pun">])),</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># 5x5 conv, 32 inputs, 64 outputs</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="str">'wc2'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">64</span><span class="pun">])),</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># fully connected, 7*7*64 inputs, 1024 outputs</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="str">'wd1'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">7</span><span class="pun">*</span><span class="lit">7</span><span class="pun">*</span><span class="lit">64</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1024</span><span class="pun">])),</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># 1024 inputs, 10 outputs (class prediction)</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="str">'out'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">1024</span><span class="pun">,</span><span class="pln"> num_classes</span><span class="pun">]))</span></code></li><li class="L0"><code class="language-python"><span class="pun">}</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">biases </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="str">'bc1'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">32</span><span class="pun">])),</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="str">'bc2'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">64</span><span class="pun">])),</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="str">'bd1'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="lit">1024</span><span class="pun">])),</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="str">'out'</span><span class="pun">:</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="pln">num_classes</span><span class="pun">]))</span></code></li><li class="L7"><code class="language-python"><span class="pun">}</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># Construct model</span></code></li><li class="L0"><code class="language-python"><span class="pln">logits </span><span class="pun">=</span><span class="pln"> conv_net</span><span class="pun">(</span><span class="pln">X</span><span class="pun">,</span><span class="pln"> weights</span><span class="pun">,</span><span class="pln"> biases</span><span class="pun">,</span><span class="pln"> keep_prob</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">prediction </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">softmax</span><span class="pun">(</span><span class="pln">logits</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># Define loss and optimizer</span></code></li><li class="L4"><code class="language-python"><span class="pln">loss_op </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reduce_mean</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">softmax_cross_entropy_with_logits</span><span class="pun">(</span></code></li><li class="L5"><code class="language-python"><span class="pln">    logits</span><span class="pun">=</span><span class="pln">logits</span><span class="pun">,</span><span class="pln"> labels</span><span class="pun">=</span><span class="pln">Y</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="pln">optimizer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">AdamOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">=</span><span class="pln">learning_rate</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">train_op </span><span class="pun">=</span><span class="pln"> optimizer</span><span class="pun">.</span><span class="pln">minimize</span><span class="pun">(</span><span class="pln">loss_op</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="com"># Evaluate model</span></code></li><li class="L1"><code class="language-python"><span class="pln">correct_pred </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">argmax</span><span class="pun">(</span><span class="pln">prediction</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">argmax</span><span class="pun">(</span><span class="pln">Y</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L2"><code class="language-python"><span class="pln">accuracy </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reduce_mean</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">cast</span><span class="pun">(</span><span class="pln">correct_pred</span><span class="pun">,</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Initialize the variables (i.e. assign their default value)</span></code></li><li class="L5"><code class="language-python"><span class="pln">init </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">global_variables_initializer</span><span class="pun">()</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="pgsu" id="234-session-run">2.3.4. Session run</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ne4g"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Start training</span></code></li><li class="L1"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Session</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> sess</span><span class="pun">:</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># Run the initializer</span></code></li><li class="L4"><code class="language-python"><span class="pln">    sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">init</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> step </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> num_steps</span><span class="pun">+</span><span class="lit">1</span><span class="pun">):</span></code></li><li class="L7"><code class="language-python"><span class="pln">        batch_x</span><span class="pun">,</span><span class="pln"> batch_y </span><span class="pun">=</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">next_batch</span><span class="pun">(</span><span class="pln">batch_size</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">        </span><span class="com"># Run optimization op (backprop)</span></code></li><li class="L9"><code class="language-python"><span class="pln">        sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">train_op</span><span class="pun">,</span><span class="pln"> feed_dict</span><span class="pun">={</span><span class="pln">X</span><span class="pun">:</span><span class="pln"> batch_x</span><span class="pun">,</span><span class="pln"> Y</span><span class="pun">:</span><span class="pln"> batch_y</span><span class="pun">,</span><span class="pln"> keep_prob</span><span class="pun">:</span><span class="pln"> dropout</span><span class="pun">})</span></code></li><li class="L0"><code class="language-python"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> step </span><span class="pun">%</span><span class="pln"> display_step </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> step </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L1"><code class="language-python"><span class="pln">            </span><span class="com"># Calculate batch loss and accuracy</span></code></li><li class="L2"><code class="language-python"><span class="pln">            loss</span><span class="pun">,</span><span class="pln"> acc </span><span class="pun">=</span><span class="pln"> sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">([</span><span class="pln">loss_op</span><span class="pun">,</span><span class="pln"> accuracy</span><span class="pun">],</span><span class="pln"> feed_dict</span><span class="pun">={</span><span class="pln">X</span><span class="pun">:</span><span class="pln"> batch_x</span><span class="pun">,</span></code></li><li class="L3"><code class="language-python"><span class="pln">                                                                 Y</span><span class="pun">:</span><span class="pln"> batch_y</span><span class="pun">,</span></code></li><li class="L4"><code class="language-python"><span class="pln">                                                                 keep_prob</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">})</span></code></li><li class="L5"><code class="language-python"><span class="pln">            </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Step "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">step</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">", Minibatch Loss= "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> \</span></code></li><li class="L6"><code class="language-python"><span class="pln">                  </span><span class="str">"{:.4f}"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">loss</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">", Training Accuracy= "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> \</span></code></li><li class="L7"><code class="language-python"><span class="pln">                  </span><span class="str">"{:.3f}"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">acc</span><span class="pun">))</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Optimization Finished!"</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="com"># Calculate accuracy for 256 MNIST test images</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Testing Accuracy:"</span><span class="pun">,</span><span class="pln"> \</span></code></li><li class="L3"><code class="language-python"><span class="pln">        sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">accuracy</span><span class="pun">,</span><span class="pln"> feed_dict</span><span class="pun">={</span><span class="pln">X</span><span class="pun">:</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">test</span><span class="pun">.</span><span class="pln">images</span><span class="pun">[:</span><span class="lit">256</span><span class="pun">],</span></code></li><li class="L4"><code class="language-python"><span class="pln">                                      Y</span><span class="pun">:</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">test</span><span class="pun">.</span><span class="pln">labels</span><span class="pun">[:</span><span class="lit">256</span><span class="pun">],</span></code></li><li class="L5"><code class="language-python"><span class="pln">                                      keep_prob</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">}))</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="com"># Testing Accuracy: 0.976562</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="8i9b" id="3-utilities">3. Utilities</h2><div class="md-section-divider"></div><h3 data-anchor-id="keyr" id="31-save-and-restore-model">3.1. Save and restore model</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="tj8c"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 'Saver' op to save and restore all the variables</span></code></li><li class="L1"><code class="language-python"><span class="pln">saver </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">Saver</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># Save model weights to disk</span></code></li><li class="L4"><code class="language-python"><span class="pln">save_path </span><span class="pun">=</span><span class="pln"> saver</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="pln">sess</span><span class="pun">,</span><span class="pln"> model_path</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="str">"Model saved in file: %s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> save_path</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln"> </span><span class="com"># Restore model weights from previously saved model</span></code></li><li class="L8"><code class="language-python"><span class="pln">load_path </span><span class="pun">=</span><span class="pln"> saver</span><span class="pun">.</span><span class="pln">restore</span><span class="pun">(</span><span class="pln">sess</span><span class="pun">,</span><span class="pln"> model_path</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="str">"Model restored from file: %s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> save_path</span><span class="pun">)</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="3jhv" id="32-visualization-tensorboard-basics">3.2. Visualization - tensorboard basics</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="q5mc"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Construct model and encapsulating all ops into scopes, making</span></code></li><li class="L1"><code class="language-python"><span class="com"># Tensorboard's Graph visualization more convenient</span></code></li><li class="L2"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">name_scope</span><span class="pun">(</span><span class="str">'Model'</span><span class="pun">):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># Model</span></code></li><li class="L4"><code class="language-python"><span class="pln">    pred </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">softmax</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">matmul</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> W</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">)</span><span class="pln"> </span><span class="com"># Softmax</span></code></li><li class="L5"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">name_scope</span><span class="pun">(</span><span class="str">'Loss'</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Minimize error using cross entropy</span></code></li><li class="L7"><code class="language-python"><span class="pln">    cost </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reduce_mean</span><span class="pun">(-</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">reduce_sum</span><span class="pun">(</span><span class="pln">y </span><span class="pun">*</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">pred</span><span class="pun">),</span><span class="pln"> reduction_indices</span><span class="pun">=</span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L8"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">name_scope</span><span class="pun">(</span><span class="str">'SGD'</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="com"># Gradient Descent</span></code></li><li class="L0"><code class="language-python"><span class="pln">    optimizer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">GradientDescentOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">).</span><span class="pln">minimize</span><span class="pun">(</span><span class="pln">cost</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">name_scope</span><span class="pun">(</span><span class="str">'Accuracy'</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># Accuracy</span></code></li><li class="L3"><code class="language-python"><span class="pln">    acc </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">argmax</span><span class="pun">(</span><span class="pln">pred</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">argmax</span><span class="pun">(</span><span class="pln">y</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="pln">    acc </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reduce_mean</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">cast</span><span class="pun">(</span><span class="pln">acc</span><span class="pun">,</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># Initializing the variables</span></code></li><li class="L7"><code class="language-python"><span class="pln">init </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">global_variables_initializer</span><span class="pun">()</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># Create a summary to monitor cost tensor</span></code></li><li class="L0"><code class="language-python"><span class="pln">tf</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">scalar</span><span class="pun">(</span><span class="str">"loss"</span><span class="pun">,</span><span class="pln"> cost</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="com"># Create a summary to monitor accuracy tensor</span></code></li><li class="L2"><code class="language-python"><span class="pln">tf</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">scalar</span><span class="pun">(</span><span class="str">"accuracy"</span><span class="pun">,</span><span class="pln"> acc</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="com"># Merge all summaries into a single op</span></code></li><li class="L4"><code class="language-python"><span class="pln">merged_summary_op </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">merge_all</span><span class="pun">()</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># Start Training</span></code></li><li class="L7"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Session</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> sess</span><span class="pun">:</span></code></li><li class="L8"><code class="language-python"><span class="pln">    sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">init</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="com"># op to write logs to Tensorboard</span></code></li><li class="L1"><code class="language-python"><span class="pln">    summary_writer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="typ">FileWriter</span><span class="pun">(</span><span class="pln">logs_path</span><span class="pun">,</span><span class="pln"> graph</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">get_default_graph</span><span class="pun">())</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># ...</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">        </span><span class="com"># Run optimization op (backprop), cost op (to get loss value)</span></code></li><li class="L6"><code class="language-python"><span class="pln">        </span><span class="com"># and summary nodes</span></code></li><li class="L7"><code class="language-python"><span class="pln">        _</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">,</span><span class="pln"> summary </span><span class="pun">=</span><span class="pln"> sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">([</span><span class="pln">optimizer</span><span class="pun">,</span><span class="pln"> cost</span><span class="pun">,</span><span class="pln"> merged_summary_op</span><span class="pun">],</span></code></li><li class="L8"><code class="language-python"><span class="pln">                                feed_dict</span><span class="pun">={</span><span class="pln">x</span><span class="pun">:</span><span class="pln"> batch_xs</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">:</span><span class="pln"> batch_ys</span><span class="pun">})</span></code></li><li class="L9"><code class="language-python"><span class="pln">        </span><span class="com"># Write logs at every iteration</span></code></li><li class="L0"><code class="language-python"><span class="pln">        summary_writer</span><span class="pun">.</span><span class="pln">add_summary</span><span class="pun">(</span><span class="pln">summary</span><span class="pun">,</span><span class="pln"> epoch </span><span class="pun">*</span><span class="pln"> total_batch </span><span class="pun">+</span><span class="pln"> i</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># Run the command line:</span></code></li><li class="L3"><code class="language-python"><span class="com"># --&gt; tensorboard --logdir=/tmp/tensorflow_logs </span></code></li><li class="L4"><code class="language-python"><span class="com"># Then open http://0.0.0.0:6006/ into your web browser</span></code></li></ol></pre><p data-anchor-id="dwvn"><strong>Loss and Accuracy Visualization</strong> <br>
<img src="http://static.zybuluo.com/HarryUp/g0f5eiguucv3yk1sbyf0rz03/tensorboard_basic_1.png" alt="tensorboard_basic_1.png-278kB" title=""></p><p data-anchor-id="0ted"><strong>Graph Visualization</strong> <br>
<img src="http://static.zybuluo.com/HarryUp/d8k0wb5c4oefaljz0dr86ouc/tensorboard_basic_2.png" alt="tensorboard_basic_2.png-340.9kB" title=""></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="zgus" id="33-visualization-tensorboard-advanced">3.3. Visualization - tensorboard advanced</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="m0qo"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">name_scope</span><span class="pun">(</span><span class="str">'SGD'</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="com"># Gradient Descent</span></code></li><li class="L2"><code class="language-python"><span class="pln">    optimizer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">GradientDescentOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># Op to calculate every variable gradient</span></code></li><li class="L4"><code class="language-python"><span class="pln">    grads </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">gradients</span><span class="pun">(</span><span class="pln">loss</span><span class="pun">,</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">trainable_variables</span><span class="pun">())</span></code></li><li class="L5"><code class="language-python"><span class="pln">    grads </span><span class="pun">=</span><span class="pln"> list</span><span class="pun">(</span><span class="pln">zip</span><span class="pun">(</span><span class="pln">grads</span><span class="pun">,</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">trainable_variables</span><span class="pun">()))</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Op to update all variables according to their gradient</span></code></li><li class="L7"><code class="language-python"><span class="pln">    apply_grads </span><span class="pun">=</span><span class="pln"> optimizer</span><span class="pun">.</span><span class="pln">apply_gradients</span><span class="pun">(</span><span class="pln">grads_and_vars</span><span class="pun">=</span><span class="pln">grads</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># Create summaries to visualize weights</span></code></li><li class="L0"><code class="language-python"><span class="kwd">for</span><span class="pln"> var </span><span class="kwd">in</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">trainable_variables</span><span class="pun">():</span></code></li><li class="L1"><code class="language-python"><span class="pln">    tf</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">histogram</span><span class="pun">(</span><span class="pln">var</span><span class="pun">.</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> var</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="com"># Summarize all gradients</span></code></li><li class="L3"><code class="language-python"><span class="kwd">for</span><span class="pln"> grad</span><span class="pun">,</span><span class="pln"> var </span><span class="kwd">in</span><span class="pln"> grads</span><span class="pun">:</span></code></li><li class="L4"><code class="language-python"><span class="pln">    tf</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">histogram</span><span class="pun">(</span><span class="pln">var</span><span class="pun">.</span><span class="pln">name </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/gradient'</span><span class="pun">,</span><span class="pln"> grad</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="udb9"><strong>Computation Graph Visualization</strong> <br>
<img src="http://static.zybuluo.com/HarryUp/y1r3rz6j2dpwzoysrq5xdhnp/tensorboard_advanced_2.png" alt="tensorboard_advanced_2.png-322.1kB" title=""></p><p data-anchor-id="ub7v"><strong>Weights and Gradients Visualization</strong> <br>
<img src="http://static.zybuluo.com/HarryUp/ikdsn7bdcgjc8kcxahdm9ffe/tensorboard_advanced_3.png" alt="tensorboard_advanced_3.png-987.3kB" title=""></p><p data-anchor-id="cjaw"><strong>Activations Visualization</strong> <br>
<img src="http://static.zybuluo.com/HarryUp/quc463yftd1m6xoacg45ed7z/tensorboard_advanced_4.png" alt="tensorboard_advanced_4.png-592.8kB" title=""></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="avzi" id="4-advanced-apis">4. Advanced APIs</h2><div class="md-section-divider"></div><h3 data-anchor-id="zgx7" id="41-high-level-package">4.1. High-level package</h3><div class="md-section-divider"></div><h4 data-anchor-id="viva" id="411-keras">4.1.1. Keras</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vc56"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> tensorflow </span><span class="kwd">import</span><span class="pln"> keras</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="u4g5"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Sequential model</span></code></li><li class="L1"><code class="language-python"><span class="pln">model </span><span class="pun">=</span><span class="pln"> keras</span><span class="pun">.</span><span class="typ">Sequential</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="com"># Adds a densely-connected layer with 64 units to the model:</span></code></li><li class="L3"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">keras</span><span class="pun">.</span><span class="pln">layers</span><span class="pun">.</span><span class="typ">Dense</span><span class="pun">(</span><span class="lit">64</span><span class="pun">,</span><span class="pln"> activation</span><span class="pun">=</span><span class="str">'relu'</span><span class="pun">))</span></code></li><li class="L4"><code class="language-python"><span class="com"># Add another:</span></code></li><li class="L5"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">keras</span><span class="pun">.</span><span class="pln">layers</span><span class="pun">.</span><span class="typ">Dense</span><span class="pun">(</span><span class="lit">64</span><span class="pun">,</span><span class="pln"> activation</span><span class="pun">=</span><span class="str">'relu'</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="com"># Add a softmax layer with 10 output units:</span></code></li><li class="L7"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">keras</span><span class="pun">.</span><span class="pln">layers</span><span class="pun">.</span><span class="typ">Dense</span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> activation</span><span class="pun">=</span><span class="str">'softmax'</span><span class="pun">))</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="pv0z"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Set up training</span></code></li><li class="L1"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">compile</span><span class="pun">(</span><span class="pln">optimizer</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">AdamOptimizer</span><span class="pun">(</span><span class="lit">0.001</span><span class="pun">),</span></code></li><li class="L2"><code class="language-python"><span class="pln">              loss</span><span class="pun">=</span><span class="str">'categorical_crossentropy'</span><span class="pun">,</span></code></li><li class="L3"><code class="language-python"><span class="pln">              metrics</span><span class="pun">=[</span><span class="str">'accuracy'</span><span class="pun">])</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># Input NumPy data</span></code></li><li class="L6"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">fit</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> labels</span><span class="pun">,</span><span class="pln"> epochs</span><span class="pun">=</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> batch_size</span><span class="pun">=</span><span class="lit">32</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com"># Evaluate and predict</span></code></li><li class="L9"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">evaluate</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> batch_size</span><span class="pun">=</span><span class="lit">32</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">predict</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> batch_size</span><span class="pun">=</span><span class="lit">32</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="901x"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> keras</span><span class="pun">.</span><span class="pln">applications </span><span class="kwd">import</span><span class="pln"> inception_v3</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="9jez" id="412-slim-tensorlayer">4.1.2. Slim (Tensorlayer)</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="5qxo"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> tensorflow</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">slim </span><span class="kwd">as</span><span class="pln"> slim</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="xu08"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">with</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">arg_scope</span><span class="pun">([</span><span class="pln">slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">],</span><span class="pln"> padding</span><span class="pun">=</span><span class="str">'SAME'</span><span class="pun">,</span></code></li><li class="L1"><code class="language-python"><span class="pln">                    weights_initializer</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">truncated_normal_initializer</span><span class="pun">(</span><span class="pln">stddev</span><span class="pun">=</span><span class="lit">0.01</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">                    weights_regularizer</span><span class="pun">=</span><span class="pln">slim</span><span class="pun">.</span><span class="pln">l2_regularizer</span><span class="pun">(</span><span class="lit">0.0005</span><span class="pun">)):</span></code></li><li class="L3"><code class="language-python"><span class="pln">    net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">inputs</span><span class="pun">,</span><span class="pln"> </span><span class="lit">64</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">11</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv1'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="lit">128</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">11</span><span class="pun">],</span><span class="pln"> padding</span><span class="pun">=</span><span class="str">'VALID'</span><span class="pun">,</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv2'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">    net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> </span><span class="lit">11</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv3'</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ccy7"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> </span><span class="pun">...</span></code></li><li class="L1"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv3_1'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv3_2'</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv3_3'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">max_pool2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'pool2'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="com"># using slim.repeat</span></code></li><li class="L7"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">repeat</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">,</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">conv2d</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'conv3'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">net </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">max_pool2d</span><span class="pun">(</span><span class="pln">net</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'pool2'</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="5f2n"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">fully_connected</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> </span><span class="lit">32</span><span class="pun">,</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'fc/fc_1'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">fully_connected</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> </span><span class="lit">64</span><span class="pun">,</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'fc/fc_2'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">fully_connected</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> </span><span class="lit">128</span><span class="pun">,</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'fc/fc_3'</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># using slim.stack</span></code></li><li class="L5"><code class="language-python"><span class="pln">slim</span><span class="pun">.</span><span class="pln">stack</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> slim</span><span class="pun">.</span><span class="pln">fully_connected</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">64</span><span class="pun">,</span><span class="pln"> </span><span class="lit">128</span><span class="pun">],</span><span class="pln"> scope</span><span class="pun">=</span><span class="str">'fc'</span><span class="pun">)</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="bl9k" id="42-estimator">4.2. Estimator</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="djbg"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Define the input function for training</span></code></li><li class="L1"><code class="language-python"><span class="pln">input_fn </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="pln">inputs</span><span class="pun">.</span><span class="pln">numpy_input_fn</span><span class="pun">(</span></code></li><li class="L2"><code class="language-python"><span class="pln">    x</span><span class="pun">={</span><span class="str">'images'</span><span class="pun">:</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">images</span><span class="pun">},</span><span class="pln"> y</span><span class="pun">=</span><span class="pln">mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">labels</span><span class="pun">,</span></code></li><li class="L3"><code class="language-python"><span class="pln">    batch_size</span><span class="pun">=</span><span class="pln">batch_size</span><span class="pun">,</span><span class="pln"> num_epochs</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> shuffle</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="c8pe"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Define the neural network</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> neural_net</span><span class="pun">(</span><span class="pln">x_dict</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="com"># TF Estimator input is a dict, in case of multiple inputs</span></code></li><li class="L3"><code class="language-python"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> x_dict</span><span class="pun">[</span><span class="str">'images'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># Hidden fully connected layer with 256 neurons</span></code></li><li class="L5"><code class="language-python"><span class="pln">    layer_1 </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">layers</span><span class="pun">.</span><span class="pln">dense</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> n_hidden_1</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Hidden fully connected layer with 256 neurons</span></code></li><li class="L7"><code class="language-python"><span class="pln">    layer_2 </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">layers</span><span class="pun">.</span><span class="pln">dense</span><span class="pun">(</span><span class="pln">layer_1</span><span class="pun">,</span><span class="pln"> n_hidden_2</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">    </span><span class="com"># Output fully connected layer with a neuron for each class</span></code></li><li class="L9"><code class="language-python"><span class="pln">    out_layer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">layers</span><span class="pun">.</span><span class="pln">dense</span><span class="pun">(</span><span class="pln">layer_2</span><span class="pun">,</span><span class="pln"> num_classes</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> out_layer</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="jgwr"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Define the model function (following TF Estimator Template)</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> model_fn</span><span class="pun">(</span><span class="pln">features</span><span class="pun">,</span><span class="pln"> labels</span><span class="pun">,</span><span class="pln"> mode</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># Build the neural network</span></code></li><li class="L4"><code class="language-python"><span class="pln">    logits </span><span class="pun">=</span><span class="pln"> neural_net</span><span class="pun">(</span><span class="pln">features</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="com"># Predictions</span></code></li><li class="L7"><code class="language-python"><span class="pln">    pred_classes </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">argmax</span><span class="pun">(</span><span class="pln">logits</span><span class="pun">,</span><span class="pln"> axis</span><span class="pun">=</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">    pred_probas </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">softmax</span><span class="pun">(</span><span class="pln">logits</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="com"># If prediction mode, early return</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> mode </span><span class="pun">==</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="typ">ModeKeys</span><span class="pun">.</span><span class="pln">PREDICT</span><span class="pun">:</span></code></li><li class="L2"><code class="language-python"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="typ">EstimatorSpec</span><span class="pun">(</span><span class="pln">mode</span><span class="pun">,</span><span class="pln"> predictions</span><span class="pun">=</span><span class="pln">pred_classes</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># Define loss and optimizer</span></code></li><li class="L5"><code class="language-python"><span class="pln">    loss_op </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reduce_mean</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">nn</span><span class="pun">.</span><span class="pln">sparse_softmax_cross_entropy_with_logits</span><span class="pun">(</span></code></li><li class="L6"><code class="language-python"><span class="pln">        logits</span><span class="pun">=</span><span class="pln">logits</span><span class="pun">,</span><span class="pln"> labels</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">cast</span><span class="pun">(</span><span class="pln">labels</span><span class="pun">,</span><span class="pln"> dtype</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">int32</span><span class="pun">)))</span></code></li><li class="L7"><code class="language-python"><span class="pln">    optimizer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">GradientDescentOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">=</span><span class="pln">learning_rate</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">    train_op </span><span class="pun">=</span><span class="pln"> optimizer</span><span class="pun">.</span><span class="pln">minimize</span><span class="pun">(</span><span class="pln">loss_op</span><span class="pun">,</span><span class="pln"> global_step</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">get_global_step</span><span class="pun">())</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="pln">    </span><span class="com"># Evaluate the accuracy of the model</span></code></li><li class="L1"><code class="language-python"><span class="pln">    acc_op </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">metrics</span><span class="pun">.</span><span class="pln">accuracy</span><span class="pun">(</span><span class="pln">labels</span><span class="pun">=</span><span class="pln">labels</span><span class="pun">,</span><span class="pln"> predictions</span><span class="pun">=</span><span class="pln">pred_classes</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">    </span><span class="com"># TF Estimators requires to return a EstimatorSpec, that specify</span></code></li><li class="L4"><code class="language-python"><span class="pln">    </span><span class="com"># the different ops for training, evaluating, ...</span></code></li><li class="L5"><code class="language-python"><span class="pln">    estim_specs </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="typ">EstimatorSpec</span><span class="pun">(</span></code></li><li class="L6"><code class="language-python"><span class="pln">      mode</span><span class="pun">=</span><span class="pln">mode</span><span class="pun">,</span></code></li><li class="L7"><code class="language-python"><span class="pln">      predictions</span><span class="pun">=</span><span class="pln">pred_classes</span><span class="pun">,</span></code></li><li class="L8"><code class="language-python"><span class="pln">      loss</span><span class="pun">=</span><span class="pln">loss_op</span><span class="pun">,</span></code></li><li class="L9"><code class="language-python"><span class="pln">      train_op</span><span class="pun">=</span><span class="pln">train_op</span><span class="pun">,</span></code></li><li class="L0"><code class="language-python"><span class="pln">      eval_metric_ops</span><span class="pun">={</span><span class="str">'accuracy'</span><span class="pun">:</span><span class="pln"> acc_op</span><span class="pun">})</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> estim_specs</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="k2ay"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Build the Estimator</span></code></li><li class="L1"><code class="language-python"><span class="pln">model </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="typ">Estimator</span><span class="pun">(</span><span class="pln">model_fn</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># Train the Model</span></code></li><li class="L4"><code class="language-python"><span class="pln">model</span><span class="pun">.</span><span class="pln">train</span><span class="pun">(</span><span class="pln">input_fn</span><span class="pun">,</span><span class="pln"> steps</span><span class="pun">=</span><span class="pln">num_steps</span><span class="pun">)</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="ojdm" id="checkpoint">Checkpoint</h4><p></p><center data-anchor-id="qtou"><img src="http://static.zybuluo.com/HarryUp/80d22sc3guyp5zhn2mvctiai/first_train_calls_meitu_1.jpg" alt="first_train_calls_meitu_1.jpg-74.2kB" title=""></center><p></p><ul data-anchor-id="hrmx">
<li>Estimators automatically write the following to disk: <br>
<ul><li><strong>checkpoints</strong>, which are versions of the model created during training.</li>
<li><strong>event files</strong>, which contain information that TensorBoard uses to create visualizations.</li></ul></li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="upq8"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">my_checkpointing_config </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="typ">RunConfig</span><span class="pun">(</span></code></li><li class="L1"><code class="language-python"><span class="pln">    save_checkpoints_secs </span><span class="pun">=</span><span class="pln"> </span><span class="lit">20</span><span class="pun">*</span><span class="lit">60</span><span class="pun">,</span><span class="pln">  </span><span class="com"># Save checkpoints every 20 minutes.</span></code></li><li class="L2"><code class="language-python"><span class="pln">    keep_checkpoint_max </span><span class="pun">=</span><span class="pln"> </span><span class="lit">10</span><span class="pun">,</span><span class="pln">       </span><span class="com"># Retain the 10 most recent checkpoints.</span></code></li><li class="L3"><code class="language-python"><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">classifier </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">estimator</span><span class="pun">.</span><span class="typ">DNNClassifier</span><span class="pun">(</span></code></li><li class="L6"><code class="language-python"><span class="pln">    feature_columns</span><span class="pun">=</span><span class="pln">my_feature_columns</span><span class="pun">,</span></code></li><li class="L7"><code class="language-python"><span class="pln">    hidden_units</span><span class="pun">=[</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">],</span></code></li><li class="L8"><code class="language-python"><span class="pln">    n_classes</span><span class="pun">=</span><span class="lit">3</span><span class="pun">,</span></code></li><li class="L9"><code class="language-python"><span class="pln">    model_dir</span><span class="pun">=</span><span class="str">'models/iris'</span><span class="pun">,</span></code></li><li class="L0"><code class="language-python"><span class="pln">    config</span><span class="pun">=</span><span class="pln">my_checkpointing_config</span><span class="pun">)</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="o9cb" id="43-database">4.3. Database</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="7n61"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Create a dataset tensor from the images and the labels</span></code></li><li class="L1"><code class="language-python"><span class="pln">dataset </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="typ">Dataset</span><span class="pun">.</span><span class="pln">from_tensor_slices</span><span class="pun">(</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="pun">(</span><span class="pln">mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">images</span><span class="pun">,</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">labels</span><span class="pun">))</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Create batches of data</span></code></li><li class="L5"><code class="language-python"><span class="pln">dataset </span><span class="pun">=</span><span class="pln"> dataset</span><span class="pun">.</span><span class="pln">batch</span><span class="pun">(</span><span class="pln">batch_size</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="com"># Create an iterator, to go over the dataset</span></code></li><li class="L8"><code class="language-python"><span class="pln">iterator </span><span class="pun">=</span><span class="pln"> dataset</span><span class="pun">.</span><span class="pln">make_initializable_iterator</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="com"># It is better to use 2 placeholders, to avoid to load all data into memory,</span></code></li><li class="L1"><code class="language-python"><span class="com"># and avoid the 2Gb restriction length of a tensor.</span></code></li><li class="L2"><code class="language-python"><span class="pln">_data </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> n_input</span><span class="pun">])</span></code></li><li class="L3"><code class="language-python"><span class="pln">_labels </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> n_classes</span><span class="pun">])</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="com"># Initialize the iterator</span></code></li><li class="L6"><code class="language-python"><span class="pln">sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">iterator</span><span class="pun">.</span><span class="pln">initializer</span><span class="pun">,</span><span class="pln"> feed_dict</span><span class="pun">={</span><span class="pln">_data</span><span class="pun">:</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">images</span><span class="pun">,</span></code></li><li class="L7"><code class="language-python"><span class="pln">                                          _labels</span><span class="pun">:</span><span class="pln"> mnist</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">labels</span><span class="pun">})</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># Neural Net Input</span></code></li><li class="L0"><code class="language-python"><span class="pln">X</span><span class="pun">,</span><span class="pln"> Y </span><span class="pun">=</span><span class="pln"> iterator</span><span class="pun">.</span><span class="pln">get_next</span><span class="pun">()</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="rr77" id="5-dynamic-mode">5. Dynamic mode</h2><div class="md-section-divider"></div><h3 data-anchor-id="zbl0" id="51-dynamic-graph">5.1. Dynamic graph</h3><ul data-anchor-id="5vw7">
<li>Static declaration VS Dynamic declaration</li>
<li>Declaration &amp; Execution</li>
<li>Virtual computing graph &amp; Entity computing graph</li>
<li>Layout, memory allocation, execution: Global VS Local</li>
<li>Efficiency VS Friendly coding</li>
<li><strong>Multi-structure input problem</strong> <br>
<ul><li>TensorFlow Fold via Dynamic Batching</li>
<li>Simulate dynamic graphs with arbitrary shape and size</li>
<li><a href="https://zhuanlan.zhihu.com/p/25216368" target="_blank">https://zhuanlan.zhihu.com/p/25216368</a></li></ul></li>
<li>(Pytorch is also quite popular in academic researches)</li>
</ul><hr><div class="md-section-divider"></div><h3 data-anchor-id="ku17" id="52-eager-mode">5.2. Eager mode</h3><div class="md-section-divider"></div><h4 data-anchor-id="c6ay" id="eager-api-basics">Eager API basics</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="69k5"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># Set Eager API</span></code></li><li class="L1"><code class="language-python"><span class="pln">tf</span><span class="pun">.</span><span class="pln">enable_eager_execution</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="pln">tfe </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">eager</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Run the operation without the need for tf.Session</span></code></li><li class="L5"><code class="language-python"><span class="pln">a </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">constant</span><span class="pun">(</span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">b </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">constant</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">c </span><span class="pun">=</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span></code></li><li class="L9"><code class="language-python"><span class="pln">d </span><span class="pun">=</span><span class="pln"> a </span><span class="pun">*</span><span class="pln"> b</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># Full compatibility with Numpy</span></code></li><li class="L2"><code class="language-python"><span class="pln">a </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">constant</span><span class="pun">([[</span><span class="lit">2.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.</span><span class="pun">],</span></code></li><li class="L3"><code class="language-python"><span class="pln">                 </span><span class="pun">[</span><span class="lit">1.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.</span><span class="pun">]],</span><span class="pln"> dtype</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">b </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">array</span><span class="pun">([[</span><span class="lit">3.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.</span><span class="pun">],</span></code></li><li class="L5"><code class="language-python"><span class="pln">              </span><span class="pun">[</span><span class="lit">5.</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.</span><span class="pun">]],</span><span class="pln"> dtype</span><span class="pun">=</span><span class="pln">np</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">c </span><span class="pun">=</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span></code></li><li class="L8"><code class="language-python"><span class="pln">d </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">matmul</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"></code></li><li class="L0"><code class="language-python"><span class="com"># Auto differentiation</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> square</span><span class="pun">(</span><span class="pln">x</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">multiply</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> x</span><span class="pun">)</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">grad </span><span class="pun">=</span><span class="pln"> tfe</span><span class="pun">.</span><span class="pln">gradients_function</span><span class="pun">(</span><span class="pln">square</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"></code></li><li class="L6"><code class="language-python"><span class="pln">square</span><span class="pun">(</span><span class="lit">3.</span><span class="pun">)</span><span class="pln">  </span><span class="com"># =&gt; 9.0</span></code></li><li class="L7"><code class="language-python"><span class="pln">grad</span><span class="pun">(</span><span class="lit">3.</span><span class="pun">)</span><span class="pln">    </span><span class="com"># =&gt; [6.0]</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="g844" id="a-toy-example">A toy example</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="pz83"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Model</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">keras</span><span class="pun">.</span><span class="typ">Model</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">  </span><span class="kwd">def</span><span class="pln"> __init__</span><span class="pun">(</span><span class="pln">self</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    super</span><span class="pun">(</span><span class="typ">Model</span><span class="pun">,</span><span class="pln"> self</span><span class="pun">).</span><span class="pln">__init__</span><span class="pun">()</span></code></li><li class="L3"><code class="language-python"><span class="pln">    self</span><span class="pun">.</span><span class="pln">W </span><span class="pun">=</span><span class="pln"> tfe</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="lit">5.</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'weight'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">    self</span><span class="pun">.</span><span class="pln">B </span><span class="pun">=</span><span class="pln"> tfe</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="lit">10.</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'bias'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">  </span><span class="kwd">def</span><span class="pln"> call</span><span class="pun">(</span><span class="pln">self</span><span class="pun">,</span><span class="pln"> inputs</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> inputs </span><span class="pun">*</span><span class="pln"> self</span><span class="pun">.</span><span class="pln">W </span><span class="pun">+</span><span class="pln"> self</span><span class="pun">.</span><span class="pln">B</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="com"># A toy dataset of points around 3 * x + 2</span></code></li><li class="L9"><code class="language-python"><span class="pln">NUM_EXAMPLES </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2000</span></code></li><li class="L0"><code class="language-python"><span class="pln">training_inputs </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="pln">NUM_EXAMPLES</span><span class="pun">])</span></code></li><li class="L1"><code class="language-python"><span class="pln">noise </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">random_normal</span><span class="pun">([</span><span class="pln">NUM_EXAMPLES</span><span class="pun">])</span></code></li><li class="L2"><code class="language-python"><span class="pln">training_outputs </span><span class="pun">=</span><span class="pln"> training_inputs </span><span class="pun">*</span><span class="pln"> </span><span class="lit">3</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> noise</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># The loss function to be optimized</span></code></li><li class="L5"><code class="language-python"><span class="kwd">def</span><span class="pln"> loss</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> inputs</span><span class="pun">,</span><span class="pln"> targets</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">  error </span><span class="pun">=</span><span class="pln"> model</span><span class="pun">(</span><span class="pln">inputs</span><span class="pun">)</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> targets</span></code></li><li class="L7"><code class="language-python"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">reduce_mean</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">square</span><span class="pun">(</span><span class="pln">error</span><span class="pun">))</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="kwd">def</span><span class="pln"> grad</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> inputs</span><span class="pun">,</span><span class="pln"> targets</span><span class="pun">):</span></code></li><li class="L0"><code class="language-python"><span class="pln">  </span><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">GradientTape</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> tape</span><span class="pun">:</span></code></li><li class="L1"><code class="language-python"><span class="pln">    loss_value </span><span class="pun">=</span><span class="pln"> loss</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> inputs</span><span class="pun">,</span><span class="pln"> targets</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> tape</span><span class="pun">.</span><span class="pln">gradient</span><span class="pun">(</span><span class="pln">loss_value</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">model</span><span class="pun">.</span><span class="pln">W</span><span class="pun">,</span><span class="pln"> model</span><span class="pun">.</span><span class="pln">B</span><span class="pun">])</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># Define:</span></code></li><li class="L5"><code class="language-python"><span class="com"># 1. A model.</span></code></li><li class="L6"><code class="language-python"><span class="com"># 2. Derivatives of a loss function with respect to model parameters.</span></code></li><li class="L7"><code class="language-python"><span class="com"># 3. A strategy for updating the variables based on the derivatives.</span></code></li><li class="L8"><code class="language-python"><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Model</span><span class="pun">()</span></code></li><li class="L9"><code class="language-python"><span class="pln">optimizer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">GradientDescentOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">=</span><span class="lit">0.01</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="str">"Initial loss: {:.3f}"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">loss</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> training_inputs</span><span class="pun">,</span><span class="pln"> training_outputs</span><span class="pun">)))</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="com"># Training loop</span></code></li><li class="L4"><code class="language-python"><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">300</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">  grads </span><span class="pun">=</span><span class="pln"> grad</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> training_inputs</span><span class="pun">,</span><span class="pln"> training_outputs</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">  optimizer</span><span class="pun">.</span><span class="pln">apply_gradients</span><span class="pun">(</span><span class="pln">zip</span><span class="pun">(</span><span class="pln">grads</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">model</span><span class="pun">.</span><span class="pln">W</span><span class="pun">,</span><span class="pln"> model</span><span class="pun">.</span><span class="pln">B</span><span class="pun">]),</span></code></li><li class="L7"><code class="language-python"><span class="pln">                            global_step</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">get_or_create_global_step</span><span class="pun">())</span></code></li><li class="L8"><code class="language-python"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> i </span><span class="pun">%</span><span class="pln"> </span><span class="lit">20</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Loss at step {:03d}: {:.3f}"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span><span class="pln"> loss</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> training_inputs</span><span class="pun">,</span><span class="pln"> training_outputs</span><span class="pun">)))</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="str">"Final loss: {:.3f}"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">loss</span><span class="pun">(</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> training_inputs</span><span class="pun">,</span><span class="pln"> training_outputs</span><span class="pun">)))</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="str">"W = {}, B = {}"</span><span class="pun">.</span><span class="pln">format</span><span class="pun">(</span><span class="pln">model</span><span class="pun">.</span><span class="pln">W</span><span class="pun">.</span><span class="pln">numpy</span><span class="pun">(),</span><span class="pln"> model</span><span class="pun">.</span><span class="pln">B</span><span class="pun">.</span><span class="pln">numpy</span><span class="pun">()))</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="jkhi" id="save-and-restore-in-eager-mode">Save and restore in eager mode</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="a9da"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">MyModel</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="pln">optimizer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">AdamOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">=</span><span class="lit">0.001</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">checkpoint_dir </span><span class="pun">=</span><span class="pln"> </span><span class="pun">‘/</span><span class="pln">path</span><span class="pun">/</span><span class="pln">to</span><span class="pun">/</span><span class="pln">model_dir</span><span class="pun">’</span></code></li><li class="L3"><code class="language-python"><span class="pln">checkpoint_prefix </span><span class="pun">=</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">checkpoint_dir</span><span class="pun">,</span><span class="pln"> </span><span class="str">"ckpt"</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">root </span><span class="pun">=</span><span class="pln"> tfe</span><span class="pun">.</span><span class="typ">Checkpoint</span><span class="pun">(</span><span class="pln">optimizer</span><span class="pun">=</span><span class="pln">optimizer</span><span class="pun">,</span></code></li><li class="L5"><code class="language-python"><span class="pln">                      model</span><span class="pun">=</span><span class="pln">model</span><span class="pun">,</span></code></li><li class="L6"><code class="language-python"><span class="pln">                      optimizer_step</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">get_or_create_global_step</span><span class="pun">())</span></code></li><li class="L7"><code class="language-python"></code></li><li class="L8"><code class="language-python"><span class="pln">root</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="pln">file_prefix</span><span class="pun">=</span><span class="pln">checkpoint_prefix</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="com"># or</span></code></li><li class="L0"><code class="language-python"><span class="pln">root</span><span class="pun">.</span><span class="pln">restore</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">latest_checkpoint</span><span class="pun">(</span><span class="pln">checkpoint_dir</span><span class="pun">))</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="8eab" id="tensorboard-in-eager-mode">Tensorboard in eager mode</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ljdp"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">writer </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">create_file_writer</span><span class="pun">(</span><span class="pln">logdir</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">global_step</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">get_or_create_global_step</span><span class="pun">()</span><span class="pln">  </span><span class="com"># return global step var</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">writer</span><span class="pun">.</span><span class="pln">set_as_default</span><span class="pun">()</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">for</span><span class="pln"> _ </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="pln">iterations</span><span class="pun">):</span></code></li><li class="L6"><code class="language-python"><span class="pln">  global_step</span><span class="pun">.</span><span class="pln">assign_add</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">  </span><span class="com"># Must include a record_summaries method</span></code></li><li class="L8"><code class="language-python"><span class="pln">  </span><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">record_summaries_every_n_global_steps</span><span class="pun">(</span><span class="lit">100</span><span class="pun">):</span></code></li><li class="L9"><code class="language-python"><span class="pln">    </span><span class="com"># your model code goes here</span></code></li><li class="L0"><code class="language-python"><span class="pln">    tf</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">summary</span><span class="pun">.</span><span class="pln">scalar</span><span class="pun">(</span><span class="str">'loss'</span><span class="pun">,</span><span class="pln"> loss</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">     </span><span class="pun">...</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="rw4f" id="use-eager-execution-in-a-graph-environment">Use eager execution in a graph environment</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="f8fb"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> my_py_func</span><span class="pun">(</span><span class="pln">x</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">  x </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">matmul</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> x</span><span class="pun">)</span><span class="pln">  </span><span class="com"># You can use tf ops</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="kwd">print</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln">  </span><span class="com"># but it's eager!</span></code></li><li class="L3"><code class="language-python"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> x</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Session</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> sess</span><span class="pun">:</span></code></li><li class="L6"><code class="language-python"><span class="pln">  x </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">placeholder</span><span class="pun">(</span><span class="pln">dtype</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">  </span><span class="com"># Call eager function in graph!</span></code></li><li class="L8"><code class="language-python"><span class="pln">  pf </span><span class="pun">=</span><span class="pln"> tfe</span><span class="pun">.</span><span class="pln">py_func</span><span class="pun">(</span><span class="pln">my_py_func</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">x</span><span class="pun">],</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">float32</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">  sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">pf</span><span class="pun">,</span><span class="pln"> feed_dict</span><span class="pun">={</span><span class="pln">x</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[[</span><span class="lit">2.0</span><span class="pun">]]})</span><span class="pln">  </span><span class="com"># [[4.0]]</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="6kce" id="53-autograph-beta">5.3. AutoGraph (beta)</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="azr7"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">pip install </span><span class="pun">-</span><span class="pln">U tf</span><span class="pun">-</span><span class="pln">nightly</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="kaqr"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">from</span><span class="pln"> tensorflow</span><span class="pun">.</span><span class="pln">contrib </span><span class="kwd">import</span><span class="pln"> autograph </span><span class="kwd">as</span><span class="pln"> ag</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="j8by" id="using-with-annotations">Using with annotations</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ovo3"><ol class="linenums"><li class="L0"><code class="language-python"><span class="lit">@ag</span><span class="pun">.</span><span class="pln">convert</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> f</span><span class="pun">(</span><span class="pln">x</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> x </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L3"><code class="language-python"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="pln">x</span></code></li><li class="L4"><code class="language-python"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> x</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="tngq"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Graph</span><span class="pun">().</span><span class="pln">as_default</span><span class="pun">():</span></code></li><li class="L1"><code class="language-python"><span class="pln">  x </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">constant</span><span class="pun">(-</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="pln">  y </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">  </span><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Session</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> sess</span><span class="pun">:</span></code></li><li class="L6"><code class="language-python"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="pln">sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">y</span><span class="pun">))</span></code></li><li class="L7"><code class="language-python"><span class="pln">    </span><span class="com"># Output: 1</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="n3qu" id="using-the-functional-api">Using the functional API</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="3n3h"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">converted_f </span><span class="pun">=</span><span class="pln"> ag</span><span class="pun">.</span><span class="pln">to_graph</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="pln">converted_f</span><span class="pun">(</span><span class="pln">tf</span><span class="pun">.</span><span class="pln">constant</span><span class="pun">(-</span><span class="lit">1</span><span class="pun">)))</span></code></li><li class="L3"><code class="language-python"><span class="com"># Output: Tensor</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="pln">f</span><span class="pun">(-</span><span class="lit">1</span><span class="pun">))</span></code></li><li class="L6"><code class="language-python"><span class="com"># Output: 1</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="kqmz"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="pln">ag</span><span class="pun">.</span><span class="pln">to_code</span><span class="pun">(</span><span class="pln">f</span><span class="pun">))</span></code></li><li class="L1"><code class="language-python"><span class="com"># Output: &lt;Python and TensorFlow code&gt;</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="9q9b" id="6-appendixs">6. Appendixs</h2><div class="md-section-divider"></div><h3 data-anchor-id="1xqq" id="61-tricks">6.1. Tricks</h3><div class="md-section-divider"></div><h4 data-anchor-id="6fpn" id="learning-rate-decay">Learning rate decay</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="uega"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">  global_step </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Variable</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> trainable</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">  starter_learning_rate </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0.1</span></code></li><li class="L2"><code class="language-python"><span class="pln">  learning_rate </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="pln">exponential_decay</span><span class="pun">(</span><span class="pln">starter_learning_rate</span><span class="pun">,</span><span class="pln"> global_step</span><span class="pun">,</span></code></li><li class="L3"><code class="language-python"><span class="pln">                                             </span><span class="lit">100000</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.96</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="pln">  </span><span class="com"># Passing global_step to minimize() will increment it at each step.</span></code></li><li class="L6"><code class="language-python"><span class="pln">  learning_step </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L7"><code class="language-python"><span class="pln">      tf</span><span class="pun">.</span><span class="pln">train</span><span class="pun">.</span><span class="typ">GradientDescentOptimizer</span><span class="pun">(</span><span class="pln">learning_rate</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">      </span><span class="pun">.</span><span class="pln">minimize</span><span class="pun">(...</span><span class="pln">my loss</span><span class="pun">...,</span><span class="pln"> global_step</span><span class="pun">=</span><span class="pln">global_step</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="pln">  </span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="a77l"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">decayed_learning_rate </span><span class="pun">=</span><span class="pln"> learning_rate </span><span class="pun">*</span></code></li><li class="L1"><code class="language-python"><span class="pln">                          decay_rate </span><span class="pun">^</span><span class="pln"> </span><span class="pun">(</span><span class="pln">global_step </span><span class="pun">/</span><span class="pln"> decay_steps</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="lgbp" id="find-anywhere-nan-is-raised">Find anywhere 'nan' is raised</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="s6ok"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">check</span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">add_check_numerics_ops</span></code></li><li class="L1"><code class="language-python"><span class="pun">...</span></code></li><li class="L2"><code class="language-python"><span class="pln">sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">([</span><span class="pln">check</span><span class="pun">,</span><span class="pln"> </span><span class="pun">...])</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="0mzn" id="filter-which-layer-to-be-freezed-through-variable-names">Filter which layer to be freezed through variable names</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="h49z"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">tvars </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">trainable_variables</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="pln">tvars </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">v </span><span class="kwd">for</span><span class="pln"> v </span><span class="kwd">in</span><span class="pln"> tvars </span><span class="kwd">if</span><span class="pln"> </span><span class="str">'frozen'</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> v</span><span class="pun">.</span><span class="pln">name</span><span class="pun">]</span></code></li><li class="L2"><code class="language-python"><span class="pln">grads </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="pln">gradients</span><span class="pun">(</span><span class="pln">loss</span><span class="pun">,</span><span class="pln"> tvars</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="ljbo" id="leverage-timeline-to-analyse-time-consumption">Leverage Timeline to analyse time consumption</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="znd0"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pln">run_metadata </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">RunMetadata</span><span class="pun">()</span></code></li><li class="L1"><code class="language-python"><span class="pln">run_options </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">RunOptions</span><span class="pun">(</span><span class="pln">trace_level</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="typ">RunOptions</span><span class="pun">.</span><span class="pln">FULL_TRACE</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="pln">config </span><span class="pun">=</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">ConfigProto</span><span class="pun">(</span><span class="pln">graph_options</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="typ">GraphOptions</span><span class="pun">(</span></code></li><li class="L3"><code class="language-python"><span class="pln">        optimizer_options</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="typ">OptimizerOptions</span><span class="pun">(</span><span class="pln">opt_level</span><span class="pun">=</span><span class="pln">tf</span><span class="pun">.</span><span class="typ">OptimizerOptions</span><span class="pun">.</span><span class="pln">L0</span><span class="pun">)))</span></code></li><li class="L4"><code class="language-python"><span class="kwd">with</span><span class="pln"> tf</span><span class="pun">.</span><span class="typ">Session</span><span class="pun">(</span><span class="pln">config</span><span class="pun">=</span><span class="pln">config</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> sess</span><span class="pun">:</span></code></li><li class="L5"><code class="language-python"><span class="pln">    c_np </span><span class="pun">=</span><span class="pln"> sess</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span><span class="pln">options</span><span class="pun">=</span><span class="pln">run_options</span><span class="pun">,</span><span class="pln">run_metadata</span><span class="pun">=</span><span class="pln">run_metadata</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">    tl </span><span class="pun">=</span><span class="pln"> timeline</span><span class="pun">.</span><span class="typ">Timeline</span><span class="pun">(</span><span class="pln">run_metadata</span><span class="pun">.</span><span class="pln">step_stats</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">    ctf </span><span class="pun">=</span><span class="pln"> tl</span><span class="pun">.</span><span class="pln">generate_chrome_trace_format</span><span class="pun">()</span></code></li><li class="L8"><code class="language-python"><span class="kwd">with</span><span class="pln"> open</span><span class="pun">(</span><span class="str">'timeline.json'</span><span class="pun">,</span><span class="str">'w'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> wd</span><span class="pun">:</span></code></li><li class="L9"><code class="language-python"><span class="pln">    wd</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">ctf</span><span class="pun">)</span></code></li><li class="L0"><code class="language-python"></code></li><li class="L1"><code class="language-python"><span class="com"># Open chrome and type: chrome://tracing</span></code></li><li class="L2"><code class="language-python"><span class="com"># and import timeline.json</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="s9gt" id="title">......</h4><hr><div class="md-section-divider"></div><h3 data-anchor-id="ue4u" id="62-extended-libraries">6.2. Extended libraries</h3><div class="md-section-divider"></div><h4 data-anchor-id="jrs4" id="cupy-dask">Cupy, Dask</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="xesn"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com"># 在一个cpu上跑 </span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> numpy </span><span class="kwd">as</span><span class="pln"> np</span></code></li><li class="L2"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> np</span><span class="pun">.</span><span class="pln">random</span><span class="pun">.</span><span class="pln">random</span><span class="pun">((</span><span class="lit">2</span><span class="pun">,</span><span class="lit">3</span><span class="pun">))</span><span class="pln">  </span></code></li><li class="L3"><code class="language-python"><span class="pln">y </span><span class="pun">=</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">T</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">np</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"><span class="pln">z </span><span class="pun">=</span><span class="pln"> y </span><span class="pun">-</span><span class="pln"> y</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">(</span><span class="pln">axis</span><span class="pun">=</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">[:</span><span class="lit">5</span><span class="pun">])</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="com"># 在GPU上跑</span></code></li><li class="L8"><code class="language-python"><span class="kwd">import</span><span class="pln"> cupy </span><span class="kwd">as</span><span class="pln"> cp</span></code></li><li class="L9"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> cp</span><span class="pun">.</span><span class="pln">random</span><span class="pun">.</span><span class="pln">random</span><span class="pun">((</span><span class="lit">2</span><span class="pun">,</span><span class="lit">3</span><span class="pun">))</span><span class="pln">  </span></code></li><li class="L0"><code class="language-python"><span class="pln">y </span><span class="pun">=</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">T</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">cp</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code class="language-python"><span class="pln">z </span><span class="pun">=</span><span class="pln"> y </span><span class="pun">-</span><span class="pln"> y</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">()</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">[:</span><span class="lit">5</span><span class="pun">].</span><span class="pln">get</span><span class="pun">())</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="com"># 在许多cpu上跑</span></code></li><li class="L5"><code class="language-python"><span class="kwd">import</span><span class="pln"> dask</span><span class="pun">.</span><span class="pln">array </span><span class="kwd">as</span><span class="pln"> da</span></code></li><li class="L6"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> da</span><span class="pun">.</span><span class="pln">random</span><span class="pun">.</span><span class="pln">random</span><span class="pun">((</span><span class="lit">2</span><span class="pun">,</span><span class="lit">3</span><span class="pun">))</span><span class="pln">  </span></code></li><li class="L7"><code class="language-python"><span class="pln">y </span><span class="pun">=</span><span class="pln"> x</span><span class="pun">.</span><span class="pln">T</span><span class="pun">.</span><span class="pln">dot</span><span class="pun">(</span><span class="pln">da</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">z </span><span class="pun">=</span><span class="pln"> y </span><span class="pun">-</span><span class="pln"> y</span><span class="pun">.</span><span class="pln">mean</span><span class="pun">(</span><span class="pln">axis</span><span class="pun">=</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L9"><code class="language-python"><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">[:</span><span class="lit">5</span><span class="pun">].</span><span class="pln">compute</span><span class="pun">())</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="tfj9" id="ray-under-development"><strong>Ray</strong> (under development)</h4><ul data-anchor-id="5oji">
<li>Ray is a Python-based distributed execution engine. </li>
<li>Developed by RISELab (AMPLab as the predecessor).</li>
<li>The same code can be run on a single machine to achieve efficient multiprocessing,  <br>
and it can be used on a cluster for large computations.</li>
<li>Asynchronous parallel.</li>
<li>scheduling latency:  <br>
<ul><li>100us level (Ray) vs 100ms level (Spark)</li></ul></li>
<li>dynamic tasks</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wfrh"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">def</span><span class="pln"> add1</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">):</span></code></li><li class="L1"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span></code></li><li class="L2"><code class="language-python"></code></li><li class="L3"><code class="language-python"><span class="lit">@ray</span><span class="pun">.</span><span class="pln">remote</span></code></li><li class="L4"><code class="language-python"><span class="kwd">def</span><span class="pln"> add2</span><span class="pun">(</span><span class="pln">a</span><span class="pun">,</span><span class="pln"> b</span><span class="pun">):</span></code></li><li class="L5"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span></code></li><li class="L6"><code class="language-python"></code></li><li class="L7"><code class="language-python"><span class="pln">x_id </span><span class="pun">=</span><span class="pln"> add2</span><span class="pun">.</span><span class="pln">remote</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"><span class="pln">ray</span><span class="pun">.</span><span class="pln">get</span><span class="pun">(</span><span class="pln">x_id</span><span class="pun">)</span><span class="pln">  </span><span class="com"># 3</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="i1fv"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> time</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="kwd">def</span><span class="pln"> f1</span><span class="pun">():</span></code></li><li class="L3"><code class="language-python"><span class="pln">    time</span><span class="pun">.</span><span class="pln">sleep</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-python"></code></li><li class="L5"><code class="language-python"><span class="lit">@ray</span><span class="pun">.</span><span class="pln">remote</span></code></li><li class="L6"><code class="language-python"><span class="kwd">def</span><span class="pln"> f2</span><span class="pun">():</span></code></li><li class="L7"><code class="language-python"><span class="pln">    time</span><span class="pun">.</span><span class="pln">sleep</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L8"><code class="language-python"></code></li><li class="L9"><code class="language-python"><span class="com"># The following takes ten seconds.</span></code></li><li class="L0"><code class="language-python"><span class="pun">[</span><span class="pln">f1</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> _ </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">10</span><span class="pun">)]</span></code></li><li class="L1"><code class="language-python"></code></li><li class="L2"><code class="language-python"><span class="com"># The following takes one second (assuming the system has at least ten CPUs).</span></code></li><li class="L3"><code class="language-python"><span class="pln">ray</span><span class="pun">.</span><span class="pln">get</span><span class="pun">([</span><span class="pln">f2</span><span class="pun">.</span><span class="pln">remote</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> _ </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">10</span><span class="pun">)])</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="744x"><ol class="linenums"><li class="L0"><code class="language-python"><span class="lit">@ray</span><span class="pun">.</span><span class="pln">remote</span></code></li><li class="L1"><code class="language-python"><span class="kwd">def</span><span class="pln"> f</span><span class="pun">(</span><span class="pln">x</span><span class="pun">):</span></code></li><li class="L2"><code class="language-python"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> x </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L3"><code class="language-python"></code></li><li class="L4"><code class="language-python"><span class="pln">x </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">remote</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L5"><code class="language-python"><span class="pln">y </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">remote</span><span class="pun">(</span><span class="pln">x</span><span class="pun">)</span></code></li><li class="L6"><code class="language-python"><span class="pln">z </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">remote</span><span class="pun">(</span><span class="pln">y</span><span class="pun">)</span></code></li><li class="L7"><code class="language-python"><span class="pln">ray</span><span class="pun">.</span><span class="pln">get</span><span class="pun">(</span><span class="pln">z</span><span class="pun">)</span><span class="pln"> </span><span class="com"># 3</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="s6sd" id="tensorly">TensorLy</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="pxzf"><ol class="linenums"><li class="L0"><code class="language-python"><span class="pun">......</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="ov3l" id="suggestion">Suggestion</h2><p data-anchor-id="iwa7">Tensorflow + Slim (TensorLayer) <br>
 Estimator + Checkpoint + TensorBoard <br>
Eager execution if you want <br>
<br>
<br>
<br>
<br>
<br></p></div>
</body>
</html>